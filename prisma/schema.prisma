generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Staff {
  id                     String              @id
  name                   String
  role                   String
  baseWage               Int
  commissionRate         Int                 @default(0)
  incentiveRate          Int                 @default(0)
  isActive               Boolean             @default(true)
  endDate                DateTime?           // Staff departure date (null = still active)
  dependents             Int                 @default(0)
  allowanceCommute       Int                 @default(0)
  allowanceMeal          Int                 @default(0)
  allowanceOther         Int                 @default(0)
  allowancePosition      Int                 @default(0)
  allowanceCommunication Int                 @default(0)
  allowanceHousing       Int                 @default(0)
  allowanceLanguage      Int                 @default(0)
  insuranceBaseSalary    Int                 @default(0)
  attendance             Attendance[]
  bookings               Booking[]
  adjustments            PayrollAdjustment[]
  shifts                 Shift[]
}

model Shift {
  id      Int      @id @default(autoincrement())
  staffId String
  date    DateTime
  status  String
  start   String?
  end     String?
  staff   Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([staffId, date])
}

model Attendance {
  id          Int      @id @default(autoincrement())
  staffId     String
  date        DateTime
  start       String?
  end         String?
  workHours   Float    @default(0)
  perfHours   Float    @default(0)
  perfReviews Int      @default(0)
  status      String
  breakTime   Float    @default(1.0)
  isOvertime  Boolean  @default(false)
  overtime    Float    @default(0)
  lateTimeOverride Int? // Manual override for late minutes (null = auto-calc)
  isManual    Boolean  @default(false)
  staff       Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model PayrollAdjustment {
  id                     Int     @id @default(autoincrement())
  staffId                String
  year                   Int
  month                  Int
  commission             Int     @default(0)
  incentive              Int     @default(0)
  bonus                  Int     @default(0)
  deduction              Int     @default(0)
  notes                  String?
  isConfirmed            Boolean @default(false)
  allowanceCommute       Int     @default(0)
  allowanceMeal          Int     @default(0)
  allowanceOther         Int     @default(0)
  allowancePosition      Int     @default(0)
  fine                   Int     @default(0)
  taxRefund              Int     @default(0)
  allowanceCommunication Int     @default(0)
  allowanceHousing       Int     @default(0)
  allowanceLanguage      Int     @default(0)
  staff                  Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([staffId, year, month])
}

model Customer {
  id       String    @id @default(uuid())
  name     String
  phone    String?
  email    String?
  notes    String?
  bookings Booking[]
}

model Service {
  id              String    @id @default(uuid())
  name            String
  duration        Int
  price           Int
  type            String
  category        String
  description     String?
  allowedStaff    String[]
  commission      Int       @default(0)
  headSpaDuration Int       @default(0)
  massageDuration Int       @default(0)
  bookings        Booking[]
}

model Booking {
  id          String    @id @default(uuid())
  menuId      String
  menuName    String
  staffId     String?
  startAt     DateTime
  endAt       DateTime
  resourceId  String
  status      String
  clientName  String?
  comboLinkId String?
  isComboMain Boolean   @default(false)
  isLocked    Boolean   @default(false) // Protect from sync overwrites
  totalPrice  Int       @default(0)
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  service     Service   @relation(fields: [menuId], references: [id])
  staff       Staff?    @relation(fields: [staffId], references: [id], onUpdate: Cascade)
}

model BookingMemo {
  id        String   @id @default(uuid())
  date      DateTime
  time      String
  persons   Int
  content   String
  hasCome   Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([date])
}
